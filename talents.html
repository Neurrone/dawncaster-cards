<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dawncaster Talents</title>
    <link rel="stylesheet" href="common.css" />
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"
    ></script>
    <script src="common.js"></script>
  </head>
  <body>
    <nav>
      <ul>
        <li><a href="cards.html">Cards</a></li>
        <li><a href="#" aria-current="page">Talents</a></li>
      </ul>
    </nav>
    <main>
      <div id="loading">Loading database...</div>
      <search class="filters" style="display: none">
        <select id="tier">
          <option value="">Talent Tier</option>
          <option value="0">Tier 0</option>
          <option value="1">Tier 1</option>
          <option value="2">Tier 2</option>
          <option value="3">Tier 3</option>
          <option value="4">Tier 4</option>
          <option value="5">Tier 5</option>
          <option value="6">Tier 6</option>
        </select>
        <select id="expansion">
          <option value="">Expansion</option>
        </select>
        <input type="text" id="search" placeholder="Search..." />
      </search>
      <div role="status" id="resultsInfo" style="display: none"></div>
      <div id="talentTableContainer" class="table-container" hidden>
        <table id="talentTable" class="data-table">
          <thead>
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Tier</th>
              <th scope="col">Prerequisites</th>
              <th scope="col">Description</th>
            </tr>
          </thead>
          <tbody>
            <!-- Table rows will be populated here -->
          </tbody>
        </table>
      </div>
    </main>
    <script>
      let db = null;
      const talentTableBody = document
        .getElementById("talentTable")
        .getElementsByTagName("tbody")[0];
      const talentTableContainer = document.getElementById(
        "talentTableContainer"
      );

      // Initialize database
      const initDB = async () => {
        try {
          db = await dawncasterCommon.loadSqlDatabase();
          dawncasterCommon.finalizeLoading();

          // Populate expansion dropdown from database
          populateExpansions();

          // Add event listeners
          dawncasterCommon.attachFilterListeners(
            ".filters select",
            fetchTalents
          );

          dawncasterCommon.setupDebouncedInput("#search", fetchTalents);

          // Initial load
          fetchTalents();
        } catch (error) {
          dawncasterCommon.handleInitializationError("loading", error);
        }
      };

      const populateExpansions = () => {
        const expansions = db.exec(
          "SELECT id, name FROM expansions ORDER BY id"
        );
        const expansionSelect = document.getElementById("expansion");
        if (expansions[0]) {
          expansions[0].values.forEach(([id, name]) => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = name;
            expansionSelect.appendChild(option);
          });
        }
      };

      const fetchTalents = () => {
        if (!db) return;

        const tier = document.getElementById("tier").value;
        const expansion = document.getElementById("expansion").value;
        const search = document.getElementById("search").value.toLowerCase();

        // Build SQL query
        let sql = `
          SELECT
            t.id, t.name, t.tier, t.expansion, t.description_html
          FROM talents t
          WHERE 1=1
        `;

        const params = {};

        if (tier) {
          sql += ` AND t.tier = $tier`;
          params["$tier"] = parseInt(tier);
        }
        if (expansion) {
          sql += ` AND t.expansion = $expansion`;
          params["$expansion"] = parseInt(expansion);
        }
        if (search) {
          sql += ` AND (
            LOWER(t.name) LIKE $search OR
            LOWER(REPLACE(REPLACE(t.description_html, '<br>', ' '), '<br/>', ' ')) LIKE $search
          )`;
          params["$search"] = `%${search}%`;
        }

        sql += ` ORDER BY t.name`;

        try {
          const results = db.exec(sql, params);

          if (results.length === 0) {
            updateDOM([]);
            return;
          }

          // Convert results to talent objects
          const talents = results[0].values.map((row) => ({
            id: row[0],
            name: row[1],
            tier: row[2],
            expansion: row[3],
            description: row[4],
          }));

          // Fetch all prerequisites in a single query
          if (talents.length > 0) {
            const talentIds = talents.map((t) => t.id).join(",");
            const prereqSql = `
              SELECT tp.talent_id, t.id, t.name
              FROM talent_prerequisites tp
              JOIN talents t ON tp.prerequisite_id = t.id
              WHERE tp.talent_id IN (${talentIds})
              ORDER BY tp.talent_id, t.name
            `;
            const prereqResults = db.exec(prereqSql);

            // Group prerequisites by talent_id
            const prereqsByTalent = {};
            if (prereqResults.length > 0) {
              prereqResults[0].values.forEach(([talentId, prereqId, prereqName]) => {
                if (!prereqsByTalent[talentId]) prereqsByTalent[talentId] = [];
                prereqsByTalent[talentId].push({ id: prereqId, name: prereqName });
              });
            }

            // Assign prerequisites to talents
            talents.forEach((talent) => {
              talent.prerequisites = prereqsByTalent[talent.id] || [];
            });
          }

          updateDOM(talents);
        } catch (error) {
          console.error("Error querying database:", error);
          updateDOM([]);
          document.getElementById(
            "resultsInfo"
          ).innerHTML = `<p class="error">Error querying database: ${error.message}</p>`;
        }
      };

      const updateDOM = (talents) => {
        const resultsInfo = document.getElementById("resultsInfo");

        if (talents.length > 0) {
          // Populate tbody first, then show table
          talentTableBody.innerHTML = talents.map(renderTalent).join("");
          talentTableContainer.hidden = false;
          resultsInfo.innerHTML = `<p>Showing ${talents.length} talent${
            talents.length !== 1 ? "s" : ""
          }</p>`;
        } else {
          // Hide table when no talents
          talentTableContainer.hidden = true;
          resultsInfo.innerHTML = `<p>No talents found.</p>`;
        }
      };

      const renderTalent = (talent) => {
        const prerequisiteNames = talent.prerequisites
          .map((p) => p.name)
          .join(", ");

        return `
          <tr>
            <th scope="row">
              <a href="https://blightbane.io/talent/${talent.name.replace(
                / /g,
                "_"
              )}">
                ${talent.name}
              </a>
            </th>
            <td>${talent.tier}</td>
            <td>${prerequisiteNames}</td>
            <td>${talent.description}</td>
          </tr>
        `;
      };

      // Initialize on page load
      initDB();
    </script>
  </body>
</html>
