<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dawncaster Cards</title>
    <link rel="stylesheet" href="common.css" />
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"
    ></script>
    <script src="common.js"></script>
  </head>
  <body>
    <nav>
      <ul>
        <li><a href="#" aria-current="page">Cards</a></li>
        <li><a href="talents.html">Talents</a></li>
      </ul>
    </nav>
    <main>
      <div id="loading">Loading database...</div>
      <search class="filters" style="display: none">
        <select id="category">
          <option value="">Category</option>
        </select>
        <select id="type">
          <option value="">Type</option>
        </select>
        <select id="rarity">
          <option value="">Rarity</option>
        </select>
        <select id="banner">
          <option value="">Banner Colour</option>
        </select>
        <select id="expansion">
          <option value="">Expansion</option>
        </select>
        <input type="text" id="search" placeholder="Search..." />
      </search>
      <div role="status" id="resultsInfo" style="display: none"></div>
      <div id="cardTableContainer" class="table-container" hidden>
        <table id="cardTable" class="data-table">
          <thead>
            <tr>
              <th scope="col">Name</th>
              <th scope="col">Category</th>
              <th scope="col">Type</th>
              <th scope="col">Rarity</th>
              <th scope="col">Cost</th>
              <th scope="col">Description</th>
            </tr>
          </thead>
          <tbody>
            <!-- Table rows will be populated here -->
          </tbody>
        </table>
      </div>
    </main>
    <script>
      let db = null;
      const cardTableBody = document
        .getElementById("cardTable")
        .getElementsByTagName("tbody")[0];
      const cardTableContainer = document.getElementById("cardTableContainer");

      const initPage = async () => {
        try {
          db = await dawncasterCommon.loadSqlDatabase();
          dawncasterCommon.finalizeLoading();

          populateFilters();

          dawncasterCommon.attachFilterListeners(
            ".filters select",
            fetchCards
          );
          dawncasterCommon.setupDebouncedInput("#search", fetchCards);

          fetchCards();
        } catch (error) {
          dawncasterCommon.handleInitializationError("loading", error);
        }
      };

      const populateFilters = () => {
        const filterConfigs = [
          {
            selectId: "category",
            query: `
              SELECT c.id, c.name
              FROM categories c
              WHERE EXISTS (
                SELECT 1 FROM cards WHERE category = c.id
              )
              ORDER BY c.id
            `,
          },
          {
            selectId: "type",
            query: `
              SELECT t.id, t.name
              FROM types t
              WHERE EXISTS (
                SELECT 1 FROM cards WHERE type = t.id
              )
              ORDER BY t.id
            `,
          },
          {
            selectId: "rarity",
            query: `
              SELECT r.id, r.name
              FROM rarities r
              WHERE EXISTS (
                SELECT 1 FROM cards WHERE rarity = r.id
              )
              ORDER BY r.id
            `,
          },
          {
            selectId: "banner",
            query: `
              SELECT co.id, co.name
              FROM colors co
              WHERE EXISTS (
                SELECT 1 FROM cards WHERE color = co.id
              )
              ORDER BY co.id
            `,
          },
          {
            selectId: "expansion",
            query: `
              SELECT e.id, e.name
              FROM expansions e
              WHERE EXISTS (
                SELECT 1 FROM cards WHERE expansion = e.id
              )
              ORDER BY e.id
            `,
          },
        ];

        filterConfigs.forEach(({ selectId, query }) => {
          const select = document.getElementById(selectId);
          if (!select) return;

          const [result] = db.exec(query.trim());
          if (!result) return;

          result.values.forEach(([id, name]) => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = name;
            select.appendChild(option);
          });
        });
      };

      const fetchCards = () => {
        if (!db) return;

        const category = document.getElementById("category").value;
        const type = document.getElementById("type").value;
        const rarity = document.getElementById("rarity").value;
        const banner = document.getElementById("banner").value;
        const expansion = document.getElementById("expansion").value;
        const search = document.getElementById("search").value.toLowerCase();

        // Don't show all cards when no filters are selected
        const resultsInfo = document.getElementById("resultsInfo");

        if (!category && !type && !rarity && !banner && !expansion && !search) {
          resultsInfo.innerHTML = `<p>Please select at least one filter to view cards.</p>`;
          cardTableContainer.hidden = true;
          return;
        }

        // Build SQL query
        let sql = `
          SELECT
            c.id, c.name, c.category, c.type, c.rarity, c.expansion, c.color, c.description_html,
            co.dex, co.int, co.str, co.holy, co.neutral, co.dexint, co.dexstr, co.intstr, co.blood,
            cat.name as category_name, t.name as type_name, r.name as rarity_name
          FROM cards c
          JOIN costs co ON c.id = co.card_id
          JOIN categories cat ON c.category = cat.id
          JOIN types t ON c.type = t.id
          JOIN rarities r ON c.rarity = r.id
          WHERE 1=1
        `;

        const params = {};

        if (category) {
          sql += ` AND c.category = $category`;
          params["$category"] = parseInt(category);
        }
        if (type) {
          sql += ` AND c.type = $type`;
          params["$type"] = parseInt(type);
        }
        if (rarity) {
          sql += ` AND c.rarity = $rarity`;
          params["$rarity"] = parseInt(rarity);
        }
        if (banner) {
          sql += ` AND c.color = $banner`;
          params["$banner"] = parseInt(banner);
        }
        if (expansion) {
          sql += ` AND c.expansion = $expansion`;
          params["$expansion"] = parseInt(expansion);
        }
        if (search) {
          sql += ` AND (
            LOWER(c.name) LIKE $search OR
            LOWER(REPLACE(REPLACE(c.description_html, '<br>', ' '), '<br/>', ' ')) LIKE $search
          )`;
          params["$search"] = `%${search}%`;
        }

        sql += ` ORDER BY c.name`;

        try {
          const results = db.exec(sql, params);

          if (results.length === 0) {
            updateDOM([]);
            return;
          }

          // Convert results to card objects
          const cards = results[0].values.map((row) => ({
            id: row[0],
            name: row[1],
            category: row[2],
            type: row[3],
            rarity: row[4],
            expansion: row[5],
            color: row[6],
            description: row[7],
            cost: {
              dex: row[8],
              int: row[9],
              str: row[10],
              holy: row[11],
              neutral: row[12],
              dexint: row[13],
              dexstr: row[14],
              intstr: row[15],
              blood: row[16],
            },
            category_name: row[17],
            type_name: row[18],
            rarity_name: row[19],
          }));

          updateDOM(cards);
        } catch (error) {
          console.error("Error querying database:", error);
          updateDOM([]);
          document.getElementById(
            "resultsInfo"
          ).innerHTML = `<p class="error">Error querying database: ${error.message}</p>`;
        }
      };

      const updateDOM = (cards) => {
        if (cards.length > 0) {
          // Populate tbody first, then show table
          cardTableBody.innerHTML = renderCards(cards);
          cardTableContainer.hidden = false;
          document.getElementById("resultsInfo").innerHTML = `<p>Showing ${
            cards.length
          } card${cards.length !== 1 ? "s" : ""}</p>`;
        } else {
          // Hide table when no cards
          cardTableContainer.hidden = true;
          document.getElementById(
            "resultsInfo"
          ).innerHTML = `<p>No cards found.</p>`;
        }
      };

      const renderCards = (cards) => {
        return cards.map(renderCard).join("");
      };

      const renderCard = (card) => {
        return `
          <tr>
            <th scope="row">
              <a href="https://blightbane.io/card/${card.name.replace(
                / /g,
                "_"
              )}">
                ${card.name}
              </a>
            </th>
            <td>${card.category_name}</td>
            <td>${card.type_name}</td>
            <td>${card.rarity_name}</td>
            <td>${getCostSummary(card.cost)}</td>
            <td>${card.description}</td>
          </tr>
        `;
      };

      const getCostSummary = (cost) => {
        const costItems = Object.entries(cost)
          .filter(([_, value]) => value > 0)
          .map(([key, value]) => `${key} ${value}`);
        return costItems.join(", ");
      };

      // Initialize on page load
      initPage();
    </script>
  </body>
</html>
