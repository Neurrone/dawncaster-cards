<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dawncaster Cards</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.0.12/purify.min.js" async></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        nav ul {
            list-style-type: none;
            padding: 0;
            margin: 0 0 20px 0;
            display: flex;
            background-color: #f2f2f2;
        }
        nav li {
            padding: 10px 20px;
        }
        nav a {
            text-decoration: none;
            color: black;
        }
        nav a[aria-current="page"] {
            font-weight: bold;
            border-bottom: 2px solid #000;
        }        

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        #resultsInfo {
            margin-bottom: 10px;
            font-weight: bold;
        }
        th[scope="row"] {
            font-weight: bold;
            background-color: #e9e9e9;
        }
    </style>
</head>
<body>
    <nav>
        <ul>
            <li><a href="#" aria-current="page">Cards</a></li>
            <li><a href="#">Talents</a></li>
        </ul>
    </nav>
    <main>
        <search class="filters">
            <select id="category">
                <option value="">Category</option>
                <option value="0">Action</option>
                <option value="1">Item</option>
                <option value="2">Artifact</option>
                <option value="3">Conjuration</option>
                <option value="4">Enchantment</option>
                <option value="5">Basic Attack</option>
                <option value="6">Summon</option>
                <option value="7">Performance</option>
                <option value="8">Form</option>
                <option value="9">Hymn</option>
                <option value="11">Revelation</option>
                <option value="12">Affix</option>
                <option value="13">Attunement</option>
                <option value="14">Equipment</option>
                <option value="15">Code</option>
            </select>
            <select id="type">
                <option value="">Type</option>
                <option value="0">Melee</option>
                <option value="1">Magic</option>
                <option value="2">Ranged</option>
                <option value="3">Utility</option>
                <option value="4">Divine</option>
                <option value="5">Move</option>
                <option value="6">Corruption</option>
                <option value="7">Monster</option>
            </select>
            <select id="rarity">
                <option value="">Rarity</option>
                <option value="0">Common</option>
                <option value="1">Uncommon</option>
                <option value="2">Rare</option>
                <option value="3">Legendary</option>
                <option value="4">Monster</option>
            </select>
            <select id="banner">
                <option value="">Banner Colour</option>
                <option value="0">None</option>
                <option value="1">Green</option>
                <option value="2">Blue</option>
                <option value="3">Red</option>
                <option value="4">Purple</option>
                <option value="5">Brown</option>
                <option value="6">Aqua</option>
                <option value="7">White</option>
                <option value="8">Gold</option>
                <option value="9">Black</option>
                <option value="10">Orange</option>
                <option value="11">Monster</option>
            </select>
            <select id="expansion">
                <option value="">Expansion</option>
                <option value="0">None</option>
                <option value="1">Core</option>
                <option value="2">Metaprogress</option>
                <option value="3">Metamorphosis</option>
                <option value="4">Core Extended</option>
                <option value="5">Infinitum</option>
                <option value="6">Catalyst</option>
            </select>
        </search>
        <div role="status" id="resultsInfo"></div>
        <table id="cardTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Type</th>
                    <th>Rarity</th>
                    <th>Cost</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <!-- Table rows will be populated here -->
            </tbody>
        </table>
    </main>
    <script>
        const cardTable = document.getElementById('cardTable').getElementsByTagName('tbody')[0];
        const cardCache = new Map(); // Cache for storing card details

        const fetchCards = async () => {
            const category = document.getElementById('category').value;
            const type = document.getElementById('type').value;
            const rarity = document.getElementById('rarity').value;
            const banner = document.getElementById('banner').value;
            const expansion = document.getElementById('expansion').value;
            const url = `https://blightbane.io/api/cards?search=&rarity=${rarity}&category=${category}&type=${type}&banner=${banner}&exp=${expansion}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`While searching for cards: ${response.status} ${response.body}`);
                }
                const data = await response.json();
                
                // Fetch detailed info for each card
                const cardDetails = await Promise.all(data.cards.map(fetchCardDetails));
                
                updateDOM(cardDetails, data.card_len);
            } catch (error) {
                console.error('Error fetching cards:', error);
                updateDOM([], 0); // Clear the table
                document.getElementById('resultsInfo').innerHTML = `<p>Error fetching cards: ${error.message}</p>`;
            }
        }

        document.querySelectorAll('select').forEach(select => {
            select.addEventListener('change', fetchCards);
        });

        const fetchCardDetails = async (card) => {
            if (cardCache.has(card.id)) {
                return cardCache.get(card.id);
            } else {
                const response = await fetch(`https://blightbane.io/api/card/${card.id}`);
                if (!response.ok) {
                    throw new Error(`Error while fetching card details: ${response}`);
                }
                const details = await response.json();
                cardCache.set(card.id, details);
                return details;
            }
        }

        const updateDOM = (cards, totalCards) => {
            const resultsInfo = document.getElementById('resultsInfo');
            resultsInfo.innerHTML = renderTooManyResultsWarningIfNeeded(cards.length, totalCards);
            cardTable.innerHTML = cards.length > 0 ? renderCards(cards) : '<tr><td colspan="6">No cards found.</td></tr>';
        }

        const renderCards = (cards) => {
            return cards.map(renderCard).join('');
        }

        const renderCard = (details) => {
            return `
                <tr>
                    <th scope="row">
                        <a href="https://blightbane.io/card/${details.name.replace(/ /g, '_')}">
                            ${details.name}
                        </a>
                    </th>
                    <td>${getCategoryName(details.category)}</td>
                    <td>${getTypeName(details.type)}</td>
                    <td>${getRarityName(details.rarity)}</td>
                    <td>${getCostSummary(details.cost)}</td>
                    <td>${DOMPurify.sanitize(details.description, {ALLOWED_TAGS: []})}</td>
                </tr>
            `;
        }

        const renderTooManyResultsWarningIfNeeded = (displayedCards, totalCards) => {
            if (displayedCards < totalCards) {
                return `<p>${displayedCards} cards out of ${totalCards} displayed. Filter to reduce the number of results.</p>`;
            }
            return '';
        }

        const getCategoryName = (categoryId) => {
            const categories = ["Action", "Item", "Artifact", "Conjuration", "Enchantment", "Basic Attack", "Summon", "Performance", "Form", "Hymn", "Talent", "Revelation", "Affix", "Attunement", "Equipment", "Code"];
            return categories[categoryId] || "Unknown";
        }

        const getTypeName = (typeId) => {
            const types = ["Melee", "Magic", "Ranged", "Utility", "Divine", "Corruption", "Monster"];
            return types[typeId] || "Unknown";
        }

        const getRarityName = (rarityId) => {
            const rarities = ["Common", "Uncommon", "Rare", "Legendary", "Monster"];
            return rarities[rarityId] || "Unknown";
        }
        
        const getCostSummary = (cost) => {
            const costItems = Object.entries(cost)
                .filter(([_, value]) => value > 0)
                .map(([key, value]) => `${key} ${value}`);
            return costItems.join(', ') || 'None';
        }

        fetchCards();
    </script>
</body>
</html>