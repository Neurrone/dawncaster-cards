<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dawncaster Cards</title>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"
    ></script>
    <style>
      body {
        font-family: Arial, sans-serif;
      }

      nav ul {
        list-style-type: none;
        padding: 0;
        margin: 0 0 20px 0;
        display: flex;
        background-color: #f2f2f2;
      }
      nav li {
        padding: 10px 20px;
      }
      nav a {
        text-decoration: none;
        color: black;
      }
      nav a[aria-current="page"] {
        font-weight: bold;
        border-bottom: 2px solid #000;
      }

      .filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      #resultsInfo {
        margin-bottom: 10px;
        font-weight: bold;
      }
      th[scope="row"] {
        font-weight: bold;
        background-color: #e9e9e9;
      }
      #loading {
        margin: 20px;
        font-size: 18px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <nav>
      <ul>
        <li><a href="#" aria-current="page">Cards</a></li>
        <li><a href="talents.html">Talents</a></li>
      </ul>
    </nav>
    <main>
      <div id="loading">Loading database...</div>
      <search class="filters" style="display: none">
        <select id="category">
          <option value="">Category</option>
        </select>
        <select id="type">
          <option value="">Type</option>
        </select>
        <select id="rarity">
          <option value="">Rarity</option>
        </select>
        <select id="banner">
          <option value="">Banner Colour</option>
        </select>
        <select id="expansion">
          <option value="">Expansion</option>
        </select>
        <input type="text" id="search" placeholder="Search..." />
      </search>
      <div role="status" id="resultsInfo" style="display: none"></div>
      <table id="cardTable" style="display: none">
        <thead>
          <tr>
            <th>Name</th>
            <th>Category</th>
            <th>Type</th>
            <th>Rarity</th>
            <th>Cost</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <!-- Table rows will be populated here -->
        </tbody>
      </table>
    </main>
    <script>
      let db = null;
      const cardTable = document
        .getElementById("cardTable")
        .getElementsByTagName("tbody")[0];
      let searchTimeout = null;

      // Initialize database
      const initDB = async () => {
        try {
          // Wait for sql.js to load
          const SQL = await initSqlJs({
            locateFile: (file) =>
              `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`,
          });

          // Load database file
          const response = await fetch("dawncaster-cards.db");
          if (!response.ok) {
            throw new Error("Failed to load database file");
          }
          const buffer = await response.arrayBuffer();
          db = new SQL.Database(new Uint8Array(buffer));

          // Hide loading message
          document.getElementById("loading").style.display = "none";

          // Show filters and table
          document.querySelector(".filters").style.display = "flex";
          document.getElementById("resultsInfo").style.display = "block";
          document.getElementById("cardTable").style.display = "";

          // Populate filter dropdowns from database
          populateFilters();

          // Add event listeners
          document.querySelectorAll("select").forEach((select) => {
            select.addEventListener("change", fetchCards);
          });

          document.getElementById("search").addEventListener("input", () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(fetchCards, 300);
          });

          // Initial load
          fetchCards();
        } catch (error) {
          console.error("Error initializing database:", error);
          document.getElementById(
            "loading"
          ).innerHTML = `<p style="color: red;">Error loading database: ${error.message}</p>`;
        }
      };

      const populateFilters = () => {
        // Populate categories
        const categories = db.exec(
          "SELECT id, name FROM categories ORDER BY id"
        );
        const categorySelect = document.getElementById("category");
        if (categories[0]) {
          categories[0].values.forEach(([id, name]) => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = name;
            categorySelect.appendChild(option);
          });
        }

        // Populate types
        const types = db.exec("SELECT id, name FROM types ORDER BY id");
        const typeSelect = document.getElementById("type");
        if (types[0]) {
          types[0].values.forEach(([id, name]) => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = name || "(None)";
            typeSelect.appendChild(option);
          });
        }

        // Populate rarities
        const rarities = db.exec("SELECT id, name FROM rarities ORDER BY id");
        const raritySelect = document.getElementById("rarity");
        if (rarities[0]) {
          rarities[0].values.forEach(([id, name]) => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = name;
            raritySelect.appendChild(option);
          });
        }

        // Populate colors
        const colors = db.exec("SELECT id, name FROM colors ORDER BY id");
        const bannerSelect = document.getElementById("banner");
        if (colors[0]) {
          colors[0].values.forEach(([id, name]) => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = name;
            bannerSelect.appendChild(option);
          });
        }

        // Populate expansions
        const expansions = db.exec(
          "SELECT id, name FROM expansions ORDER BY id"
        );
        const expansionSelect = document.getElementById("expansion");
        if (expansions[0]) {
          expansions[0].values.forEach(([id, name]) => {
            const option = document.createElement("option");
            option.value = id;
            option.textContent = name;
            expansionSelect.appendChild(option);
          });
        }
      };

      const fetchCards = () => {
        if (!db) return;

        const category = document.getElementById("category").value;
        const type = document.getElementById("type").value;
        const rarity = document.getElementById("rarity").value;
        const banner = document.getElementById("banner").value;
        const expansion = document.getElementById("expansion").value;
        const search = document.getElementById("search").value.toLowerCase();

        // Don't show all cards when no filters are selected
        if (!category && !type && !rarity && !banner && !expansion && !search) {
          const resultsInfo = document.getElementById("resultsInfo");
          resultsInfo.innerHTML = `<p>Please select at least one filter to view cards.</p>`;
          cardTable.innerHTML = '';
          return;
        }

        // Build SQL query
        let sql = `
          SELECT
            c.id, c.name, c.category, c.type, c.rarity, c.expansion, c.color, c.description_html,
            co.dex, co.int, co.str, co.holy, co.neutral, co.dexint, co.dexstr, co.intstr, co.blood,
            cat.name as category_name, t.name as type_name, r.name as rarity_name
          FROM cards c
          JOIN costs co ON c.id = co.card_id
          JOIN categories cat ON c.category = cat.id
          JOIN types t ON c.type = t.id
          JOIN rarities r ON c.rarity = r.id
          WHERE 1=1
        `;

        const params = {};

        if (category) {
          sql += ` AND c.category = $category`;
          params["$category"] = parseInt(category);
        }
        if (type) {
          sql += ` AND c.type = $type`;
          params["$type"] = parseInt(type);
        }
        if (rarity) {
          sql += ` AND c.rarity = $rarity`;
          params["$rarity"] = parseInt(rarity);
        }
        if (banner) {
          sql += ` AND c.color = $banner`;
          params["$banner"] = parseInt(banner);
        }
        if (expansion) {
          sql += ` AND c.expansion = $expansion`;
          params["$expansion"] = parseInt(expansion);
        }
        if (search) {
          sql += ` AND (
            LOWER(c.name) LIKE $search OR
            LOWER(REPLACE(REPLACE(c.description_html, '<br>', ' '), '<br/>', ' ')) LIKE $search
          )`;
          params["$search"] = `%${search}%`;
        }

        sql += ` ORDER BY c.name`;

        try {
          const results = db.exec(sql, params);

          if (results.length === 0) {
            updateDOM([], 0);
            return;
          }

          // Convert results to card objects
          const cards = results[0].values.map((row) => ({
            id: row[0],
            name: row[1],
            category: row[2],
            type: row[3],
            rarity: row[4],
            expansion: row[5],
            color: row[6],
            description: row[7],
            cost: {
              dex: row[8],
              int: row[9],
              str: row[10],
              holy: row[11],
              neutral: row[12],
              dexint: row[13],
              dexstr: row[14],
              intstr: row[15],
              blood: row[16],
            },
            category_name: row[17],
            type_name: row[18],
            rarity_name: row[19],
          }));

          updateDOM(cards, cards.length);
        } catch (error) {
          console.error("Error querying database:", error);
          updateDOM([], 0);
          document.getElementById(
            "resultsInfo"
          ).innerHTML = `<p style="color: red;">Error querying database: ${error.message}</p>`;
        }
      };

      const updateDOM = (cards, totalCards) => {
        const resultsInfo = document.getElementById("resultsInfo");
        resultsInfo.innerHTML = `<p>Showing ${cards.length} card${
          cards.length !== 1 ? "s" : ""
        }</p>`;

        cardTable.innerHTML =
          cards.length > 0
            ? renderCards(cards)
            : '<tr><td colspan="6">No cards found.</td></tr>';
      };

      const renderCards = (cards) => {
        return cards.map(renderCard).join("");
      };

      const renderCard = (card) => {
        return `
          <tr>
            <th scope="row">
              <a href="https://blightbane.io/card/${card.name.replace(
                / /g,
                "_"
              )}">
                ${card.name}
              </a>
            </th>
            <td>${card.category_name}</td>
            <td>${card.type_name}</td>
            <td>${card.rarity_name}</td>
            <td>${getCostSummary(card.cost)}</td>
            <td>${card.description}</td>
          </tr>
        `;
      };

      const getCostSummary = (cost) => {
        const costItems = Object.entries(cost)
          .filter(([_, value]) => value > 0)
          .map(([key, value]) => `${key} ${value}`);
        return costItems.join(", ");
      };

      // Initialize on page load
      initDB();
    </script>
  </body>
</html>
