# CLAUDE.md

## Project Overview

This is a static website that provides an alternative interface for browsing Dawncaster game data through the Blightbane API. The site consists of two main pages:

- `cards.html` - Browse and filter game cards, alternate interface for https://blightbane.io/cards
- `talents.html` - Browse and filter talent information, alternate interface for https://blightbane.io/talents

Both pages are standalone HTML files with embedded CSS and JavaScript. There is no build process, package manager, or dependencies beyond DOMPurify loaded from CDN.

## Architecture

### API Integration

All data comes from the Blightbane API at `https://blightbane.io/api`:

- **Card listing**: `GET /api/cards?search=&rarity=&category=&type=&banner=&exp=`
- **Card details**: `GET /api/card/{id}`
- **Talent details**: `GET /api/card/{id}?talent=true`

#### API Query Requirements

**CRITICAL: All query parameters must be present even if empty.** The API expects:

```
/api/cards?search=&rarity=&category=&type=&banner=&exp=
```

Missing parameters will cause the query to fail. Empty values are valid and return unfiltered results for that parameter.

#### API Best Practices

**NEVER spam the API.** Do NOT:

- Loop through large ranges of card IDs (e.g., `for id in range(1, 2000)`)
- Make rapid sequential requests without rate limiting
- Perform exhaustive searches when targeted queries are possible

**DO use filter parameters intelligently:**

- If you know a card is "rare gold", use `?rarity=2&banner=8`
- If you know the card category, include it in the query
- Use the search parameter for text-based queries
- Combine filters to narrow results before fetching individual card details

#### API Response Format

The API returns HTML markup in description fields, including:

- `<b>` tags for bold text
- `<br>` or `<br/>` tags for line breaks
- Other formatting tags as needed

Descriptions must be sanitized before rendering to prevent XSS attacks.

#### Extracting Filter Values from Blightbane

**The Blightbane website is a client-side JavaScript application.** The raw HTML does not contain dropdown options - they are dynamically generated by JavaScript. To get the authoritative, up-to-date filter values:

1. **Find the current bundle version:**

   ```bash
   curl -s 'https://blightbane.io' | grep -o 'index.bundle.js?v=[0-9.]*'
   ```

   Example output: `index.bundle.js?v=0.20.5`

2. **Fetch the JavaScript bundle:**

   ```bash
   VERSION="0.20.5"  # Use version from step 1
   curl -s "https://blightbane.io/js/index.bundle.js?v=${VERSION}" > bundle.js
   ```

3. **Extract filter arrays using regex patterns:**

   ```bash
   # Categories
   grep -oP '"Action","Item"[^]]*' bundle.js | head -1

   # Types
   grep -oP '"Melee","Magic"[^]]*' bundle.js | head -1

   # Rarities
   grep -oP '"Common","Uncommon"[^]]*' bundle.js | head -1

   # Banners/Colors
   grep -oP '"Green","Blue","Red","Purple"[^]]*' bundle.js | head -1

   # Expansions
   grep -oP '"Core","Metaprogress"[^]]*' bundle.js | head -1
   ```

**Important notes:**

- Array index corresponds to the API filter value (e.g., "Rare" is at index 2, so use `?rarity=2`)
- Some filters prepend "None" at index 0 (banners/colors and expansions)
- This is the same approach used by `scripts/create-db.py` to populate the database

### Functional Programming Style

The code follows a functional approach with:

- Pure render functions that map data to HTML strings
- Separate functions for data fetching and DOM updates
- Immutable data transformations using `map`, `filter`, and `join`

### Data Flow

1. User selects filter options
2. `fetchCards()` or `fetchTalents()` makes call to get info
3. Data is transformed and passed to render functions
4. DOM is updated with new table rows

## Development

### Running Locally

Open `cards.html` or `talents.html` directly in a web browser. No server required.

### Testing Changes

Simply refresh the browser after editing the HTML files. Browser DevTools console will show any JavaScript errors or API failures.

## Local Database Approach

The html files get their data from an SQLite database, which needs to be generated ahead of time by crawling the API.

### Database Generation

The `create-db/run.py` script builds a complete SQLite database from the Blightbane API:

```bash
uv run create-db/run.py dawncaster-cards.db
```

**What it does:**

1. Fetches filter values from Blightbane JavaScript bundle (always up-to-date)
2. Queries all 96 rarity/color combinations to collect all card IDs
3. Fetches detailed info for each card with 0.5s rate limiting (respects API)
4. Sanitizes HTML descriptions (keeps `<br>` tags, strips everything else)
5. Stores everything in SQLite with STRICT tables and foreign key enforcement

**Database contains:**

- ~1,672 cards
- Lookup tables: categories, types, rarities, expansions, colors
- Main cards table with foreign keys
- Costs table with resource breakdowns
- Talents
